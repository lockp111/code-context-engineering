# 改动影响分析

> 仅当重构或评估改动影响时加载此文件

## 模块依赖图

```
                    ┌─────────────┐
                    │ shared/utils │ ← 被依赖最多，改动影响最大
                    └──────┬──────┘
           ┌───────────────┼───────────────┐
           ↓               ↓               ↓
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │ services/*  │ │ middleware/ │ │  models/*   │
    └──────┬──────┘ └──────┬──────┘ └──────┬──────┘
           │               │               │
           └───────────────┼───────────────┘
                           ↓
                    ┌─────────────┐
                    │   routes/*  │
                    └─────────────┘
```

## 模块影响级别

| 模块 | 被依赖数 | 影响级别 | 修改后必须 |
| ---- | -------- | -------- | ---------- |
| `shared/utils` | 12 | 🔴 高 | 全量回归测试 |
| `core/engine` | 8 | 🔴 高 | 完整测试套件 |
| `services/auth` | 6 | 🔴 高 | 安全审查 |
| `services/order` | 5 | 🟠 中 | 订单流程测试 |
| `middleware/*` | 4 | 🟠 中 | API 集成测试 |
| `repositories/*` | 3 | 🟡 低 | 单元测试 |
| `routes/*` | 0 | 🟡 低 | 接口测试 |

## 变更传播路径

| 修改位置 | 直接影响 | 间接影响 | 测试策略 |
| -------- | -------- | -------- | -------- |
| `shared/utils` | 所有 services | 所有功能 | 全量回归 |
| `services/auth` | middleware | 所有需认证接口 | 认证 + E2E |
| `services/order` | payment, inventory | 订单相关页面 | 订单流程 E2E |
| `models/*` | repositories | services | 数据层测试 |
| `routes/*` | 无 | 无 | 接口测试 |

## 修改范围 → 测试策略

| 修改范围 | 推荐测试 | 覆盖要求 |
| -------- | -------- | -------- |
| 工具函数 | 单元测试 | 100% |
| 业务逻辑 | 单元 + 集成 | 核心路径 |
| API 端点 | 集成 + E2E | 正常 + 异常 |
| 数据模型 | 数据层 + 集成 | CRUD + 约束 |
| 全局配置 | 全量回归 | 全部 |

## 安全修改检查

修改以下内容时，必须额外进行安全审查：

| 类型 | 文件 | 审查要点 |
| ---- | ---- | -------- |
| 认证 | `services/auth.ts` | Token 生成/验证逻辑 |
| 授权 | `middleware/permission.ts` | 权限检查完整性 |
| 数据 | `repositories/*.ts` | SQL 注入、数据泄露 |
| 支付 | `services/payment/*` | 金额校验、幂等性 |
