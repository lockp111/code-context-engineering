# 危险区域

> 仅当修改 🔴🟠 风险区域时加载此文件

## 高风险文件详情

### 🔴 migrations/
- **风险**: 数据丢失、生产事故
- **规则**: 只能追加新文件，禁止修改/删除已有文件
- **原因**: 已执行的 migration 无法回滚，修改会导致环境不一致
- **检查**: 确认 migration 文件名包含时间戳且未被执行

### 🔴 services/payment/
- **风险**: 资金安全
- **规则**: 必须双人 Review + 完整测试
- **关键点**:
  - 回调必须验签 `verifySignature()`
  - 金额必须用 Decimal，禁止浮点数
  - 幂等处理：同一 transaction_id 不重复处理
  - 测试必须覆盖：成功、失败、超时、重复回调

### 🟠 middleware/auth.ts
- **风险**: 认证绕过
- **规则**: 修改后需完整测试 + 安全审查
- **检查项**:
  - Token 过期校验
  - 权限检查完整性
  - 敏感接口白名单

### 🟠 config/prod.ts
- **风险**: 生产事故
- **规则**: 需人工审核，禁止自动合并
- **禁止**: 硬编码密钥、修改数据库连接

## 禁止操作

| 操作 | 原因 | 替代方案 |
| ---- | ---- | -------- |
| 直接操作生产数据库 | 数据丢失 | 通过 migration |
| 硬编码密钥/凭证 | 安全泄露 | 环境变量 |
| 删除/重命名公开 API | 破坏兼容性 | 版本化 API |
| 修改已有 migration | 环境不一致 | 新建 migration |

## 需要审批的操作

| 操作 | 审批流程 |
| ---- | -------- |
| 修改数据模型 | 提供迁移计划 + DBA Review |
| 更新核心依赖 | 兼容性测试报告 |
| 修改认证逻辑 | 安全 Review |
| 修改第三方集成 | 对接方确认 |

## 安全检查清单

- [ ] 用户输入已验证（zod/joi）
- [ ] 敏感数据已加密存储
- [ ] API 有权限检查
- [ ] 日志不含敏感信息（密码、token、身份证）
- [ ] SQL 无注入风险（使用参数化查询）
