# å…³é”®æµç¨‹

> ä»…å½“ç†è§£å¤æ‚ä¸šåŠ¡æµç¨‹æˆ–çŠ¶æ€æœºç»†èŠ‚æ—¶åŠ è½½æ­¤æ–‡ä»¶

## æµç¨‹æ¦‚è§ˆ

| æµç¨‹ | ç±»å‹ | å…¥å£ | æ¶‰åŠæ¨¡å— |
| ---- | ---- | ---- | -------- |
| è®¢å•å¤„ç† | å·¥ä½œæµ | `OrderService.create()` | order, payment, inventory |
| ç”¨æˆ·è®¤è¯ | å·¥ä½œæµ | `AuthService.login()` | auth, user, session |
| è®¢å•çŠ¶æ€ | çŠ¶æ€æœº | `Order.status` | order |
| ç”¨æˆ·çŠ¶æ€ | çŠ¶æ€æœº | `User.status` | user |

## è®¢å•å¤„ç†æµç¨‹

**å…¥å£**: `services/order.ts` â†’ `create()`

```
ä¸‹å• â†’ æ ¡éªŒåº“å­˜ â”€å¤±è´¥â†’ è¿”å›é”™è¯¯
         â†“æˆåŠŸ
      é”å®šåº“å­˜ â†’ åˆ›å»ºè®¢å•(pending) â†’ ç­‰å¾…æ”¯ä»˜ â”€è¶…æ—¶â†’ é‡Šæ”¾åº“å­˜ â†’ å–æ¶ˆ
                                      â†“æˆåŠŸ
                                   æ‰£å‡åº“å­˜ â†’ æ›´æ–°(paid) â†’ é€šçŸ¥å‘è´§
```

| æ­¥éª¤ | æ–‡ä»¶ | å‡½æ•° |
| ---- | ---- | ---- |
| æ ¡éªŒåº“å­˜ | `services/inventory.ts` | `checkStock()` |
| é”å®šåº“å­˜ | `services/inventory.ts` | `lockStock()` |
| åˆ›å»ºè®¢å• | `services/order.ts` | `create()` |
| æ”¯ä»˜å¤„ç† | `services/payment.ts` | `processPayment()` |
| æ‰£å‡åº“å­˜ | `services/inventory.ts` | `deductStock()` |

**å¼‚å¸¸å¤„ç†**:
| å¼‚å¸¸ | å¤„ç† |
| ---- | ---- |
| åº“å­˜ä¸è¶³ | è¿”å› `BizError(3001)` |
| æ”¯ä»˜å¤±è´¥ | ä¿ç•™è®¢å• pending |
| æ”¯ä»˜è¶…æ—¶(30min) | è‡ªåŠ¨å–æ¶ˆ + é‡Šæ”¾åº“å­˜ |

## ç”¨æˆ·è®¤è¯æµç¨‹

**å…¥å£**: `services/auth.ts` â†’ `login()`

```
éªŒè¯æ ¼å¼ â”€å¤±è´¥â†’ 400
    â†“
æŸ¥è¯¢ç”¨æˆ· â”€ä¸å­˜åœ¨â†’ 401
    â†“
éªŒè¯å¯†ç  â”€å¤±è´¥â†’ 401 + è®°å½•æ¬¡æ•° â”€è¶…5æ¬¡â†’ é”å®š
    â†“æˆåŠŸ
ç”ŸæˆToken â†’ åˆ›å»ºä¼šè¯ â†’ è¿”å›
```

## è®¢å•çŠ¶æ€æœº

**å­—æ®µ**: `Order.status` | **ä½ç½®**: `models/order.ts`

```
pending(0) â”€â”€æ”¯ä»˜æˆåŠŸâ”€â”€â†’ paid(1) â”€â”€å‘è´§â”€â”€â†’ shipped(2) â”€â”€ç¡®è®¤æ”¶è´§â”€â”€â†’ completed(3)
    â”‚                      â”‚                                              
    â””â”€â”€è¶…æ—¶/å–æ¶ˆâ”€â”€â†’ cancelled(4) â†â”€â”€é€€æ¬¾â”€â”€â”˜                               
```

| å½“å‰ | å…è®¸è½¬æ¢ | è§¦å‘ | å‡½æ•° |
| ---- | -------- | ---- | ---- |
| pending | paid | æ”¯ä»˜å›è°ƒ | `onPaymentSuccess()` |
| pending | cancelled | è¶…æ—¶/ç”¨æˆ·å–æ¶ˆ | `cancelOrder()` |
| paid | shipped | å•†å®¶å‘è´§ | `shipOrder()` |
| paid | cancelled | é€€æ¬¾ | `refundOrder()` |
| shipped | completed | ç¡®è®¤æ”¶è´§/è¶…æ—¶ | `completeOrder()` |

**ğŸ”´ ç¦æ­¢**: `completed/cancelled` æ˜¯ç»ˆæ€ï¼Œç¦æ­¢ä»»ä½•è½¬æ¢

## ç”¨æˆ·çŠ¶æ€æœº

**å­—æ®µ**: `User.status`

```
inactive(0) â”€â”€é‚®ç®±éªŒè¯â”€â”€â†’ active(1) â†â”€â”€ç”³è¯‰é€šè¿‡â”€â”€â”
                              â”‚                  â”‚
                              â””â”€â”€è¿è§„â”€â”€â†’ suspended(2)
```

| çŠ¶æ€ | å€¼ | æƒé™ |
| ---- | -- | ---- |
| inactive | 0 | ä¸å¯ç™»å½• |
| active | 1 | å®Œæ•´æƒé™ |
| suspended | 2 | åªè¯» |

## å®šæ—¶ä»»åŠ¡

| ä»»åŠ¡ | Cron | åŠŸèƒ½ |
| ---- | ---- | ---- |
| è®¢å•è¶…æ—¶ | `*/5 * * * *` | å–æ¶ˆ30minæœªæ”¯ä»˜è®¢å• |
| è‡ªåŠ¨æ”¶è´§ | `0 2 * * *` | å‘è´§15å¤©åè‡ªåŠ¨å®Œæˆ |

## ä¿®æ”¹æ³¨æ„

| å˜æ›´ç±»å‹ | æ£€æŸ¥é¡¹ |
| -------- | ------ |
| çŠ¶æ€æœºå˜æ›´ | å­˜é‡æ•°æ®å…¼å®¹æ€§ |
| æµç¨‹å˜æ›´ | å¼‚å¸¸å¤„ç† + å›æ»šé€»è¾‘ |
| æ–°å¢çŠ¶æ€ | è½¬æ¢è§„åˆ™ + æƒé™æ£€æŸ¥ |
